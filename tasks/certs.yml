- name: Download Consul CA root
  shell: set -o pipefail && curl http://127.0.0.1:8500/v1/agent/connect/ca/roots | jq '.Roots[] | .RootCert' -r > /etc/consul/ssl/connect-ca.crt
  args:
    executable: /bin/bash
  changed_when: false

- name: Set Consul CA root permissions
  file:
    path: /etc/consul/ssl/connect-ca.crt
    owner: consul
    group: bin
    mode: '0644'

- name: Template cert refresh script
  template:
    src: refresh_certs.sh.j2
    dest: "/etc/consul/refresh_certs_{{ item.value['shortname'] }}"
    owner: root
    group: root
    mode: '0744'
  loop: "{{ network_settings | from_json | dict2items }}"

- name: Run cert refresh script
  script:
    cmd: "/etc/consul/refresh_certs_{{ item.value['shortname'] }}"
  loop: "{{ network_settings | from_json | dict2items }}"

- name: Install cert refresh cron
  cron:
    name: "Refresh mTLS certs"
    minute: "{{ 60 | random(seed=aws_instance_id.content) }}"
    hour: 3
    job: "/etc/consul/refresh_certs_{{ item.value['shortname'] }}"
  loop: "{{ network_settings | from_json | dict2items }}"